// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}


model User {
  id                Int                @id @default(autoincrement())
  name              String
  email             String             @unique
  password          String
  phone             String?
  status            String             @default("active")
  roles             UserRole[]
  enrollments       Enrollment[]
  orders            Order[]
  lessonCompletions LessonCompletion[]
  couponUsages      CouponUsage[]
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
}

model Role {
  id          Int             @id @default(autoincrement())
  name        String          @unique
  description String?
  users       UserRole[]
  permissions RolePermission[]
}

model Permission {
  id          Int             @id @default(autoincrement())
  name        String          @unique
  description String?
  roles       RolePermission[]
}

// Many-to-Many User <-> Role
model UserRole {
  id     Int  @id @default(autoincrement())
  user   User @relation(fields: [userId], references: [id])
  userId Int
  role   Role @relation(fields: [roleId], references: [id])
  roleId Int

  @@unique([userId, roleId])
}

// Many-to-Many Role <-> Permission
model RolePermission {
  id           Int         @id @default(autoincrement())
  role         Role        @relation(fields: [roleId], references: [id])
  roleId       Int
  permission   Permission  @relation(fields: [permissionId], references: [id])
  permissionId Int

  @@unique([roleId, permissionId])
}

model Teacher {
  id        Int      @id @default(autoincrement())
  name      String
  bio       String?
  avatarUrl String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  courses   Course[]
}

model Course {
  id             Int          @id @default(autoincrement())
  title           String
  slug            String       @unique
  description     String?
  summary         String?
  price           Float        @default(0)
  salePrice       Float?
  status          String       @default("draft")
  coverImage      String?
  previewVideoUrl String?
  teacher         Teacher?     @relation(fields: [teacherId], references: [id])
  teacherId       Int?
  sections        Section[]
  lessons         Lesson[]
  enrollments     Enrollment[]
  orders          Order[]
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
}

model Section {
  id            Int      @id @default(autoincrement())
  course         Course   @relation(fields: [courseId], references: [id])
  courseId       Int
  title          String
  sortOrder      Int      @default(0)
  videoUrl       String?
  attachmentUrl String?
  lessons        Lesson[]
}

model Lesson {
  id                Int                @id @default(autoincrement())
  course            Course             @relation(fields: [courseId], references: [id])
  courseId          Int
  section           Section?           @relation(fields: [sectionId], references: [id])
  sectionId         Int?
  title             String
  contentType       String             // "video" | "text" | "file"
  contentUrl        String?
  contentText       String?
  duration          Int?               // นาที
  sortOrder         Int                @default(0)
  lessonCompletions LessonCompletion[]
}

model Enrollment {
  id         Int      @id @default(autoincrement())
  user       User     @relation(fields: [userId], references: [id])
  userId     Int
  course     Course   @relation(fields: [courseId], references: [id])
  courseId   Int
  enrolledAt DateTime @default(now())
  expireAt   DateTime?

  @@unique([userId, courseId])
}

model Order {
  id            Int       @id @default(autoincrement())
  orderId       String    @unique
  userId        Int
  courseId      Int
  amount        Float
  status        String    @default("pending")
  paymentType   String?
  transactionId String?
  paymentUrl    String?
  qrImageUrl    String?
  couponId      Int?
  discountAmount Float    @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  user   User   @relation(fields: [userId], references: [id])
  course Course @relation(fields: [courseId], references: [id])
  coupon  Coupon? @relation(fields: [couponId], references: [id])
  couponUsage CouponUsage[]
}

model LessonCompletion {
  id          Int      @id @default(autoincrement())
  user        User     @relation(fields: [userId], references: [id])
  userId      Int
  lesson      Lesson   @relation(fields: [lessonId], references: [id])
  lessonId    Int
  completedAt DateTime @default(now())

  @@unique([userId, lessonId])
}

model Coupon {
  id              Int           @id @default(autoincrement())
  code            String         @unique
  description     String?
  discountType    String         // "percentage" | "fixed"
  discountValue   Float          // เปอร์เซ็นต์หรือจำนวนเงิน
  minPurchaseAmount Float?       // ราคาขั้นต่ำที่ต้องซื้อ
  maxDiscountAmount Float?       // ส่วนลดสูงสุด (สำหรับ percentage)
  validFrom       DateTime
  validUntil      DateTime
  usageLimit      Int?           // จำนวนครั้งที่ใช้ได้ (null = ไม่จำกัด)
  usageCount      Int            @default(0)
  userLimit       Int?           // จำนวนครั้งที่ผู้ใช้แต่ละคนใช้ได้ (null = ไม่จำกัด)
  courseIds       String?        // JSON array ของ course IDs (null = ใช้ได้ทุกคอร์ส)
  status          String         @default("active") // "active" | "inactive"
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  orders          Order[]
  couponUsages    CouponUsage[]
}

model CouponUsage {
  id          Int      @id @default(autoincrement())
  couponId    Int
  userId      Int
  orderId     Int      @unique
  discountAmount Float
  usedAt      DateTime @default(now())

  coupon      Coupon   @relation(fields: [couponId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id])
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([couponId])
}
